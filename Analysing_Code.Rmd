---
title: Analysing code for Vulnerability of Blue Foods to Human-induced Environmental Change
output: html_notebook
---
**author**: **Ling Cao**, Benjamin S. Halpern, Max Troell, Rebecca Short, Cong Zeng, Ziyu Jiang, Yue Liu, Chengxuan Zou, Shurong Liu, Chunyu Liu, Xiangwei Liu, William W. L. Cheung, Richard S. Cottrell, Fabrice DeClerck, Stefan Gelcich, Jessica A. Gephart, Dakoury Godo-Solo, Jessie Ihilani Kaull, Fiorenza Micheli, Rosamond L. Naylor, Hanna J. Payne, Elizabeth R. Selig, U. Rashid Sumaila, Michelle Tigchelaar

## Libraries for plotting

```{r}
# devtools::install_github("ricardo-bion/ggradar", dependencies = TRUE)
pacman::p_load(sf, tmap, tidyverse, stringr, measurements, ggthemes, patchwork, pheatmap,
               ggradar, ggplotify, aplot, magrittr, ggrepel, ggpubr, scales, tidytext,
               car, ggrepel)
```

## Gather Data for Plotting

### Load the Index of Analysis

```{r}
COUNTRY_TITLE <- read.csv('../ORGANIZED_DATA/00_COUNTRY_INFO.csv')
COUNTRY_INDEX <- names(COUNTRY_TITLE)
COUNTRY_ABB <- read_excel('../ORGANIZED_DATA/00-COUNTRY_ABB.xlsx')
```

### Load Summarise Table of Both Systems

```{r}
# Define the sequence of both system's tibble column title

SEQ_FW_TITLE <- c(COUNTRY_INDEX,
                  'Disease', 'Parasite', 'Invasion', 
                  'Eutrophication', 'Precipitation', 'Warming',
                  'Severe_weather_events', 'Mercury', 'POPs',
                  'Antibiotic', 'Pesticide', 'HAB', 'Bacteria',
                  'FCQ', 'FAQ', 'FCS', 'FAS', 'Climatic', 
                  'Nonclimatic', 'Biological', 'Chemical')
SEQ_MARINE_TITLE <- c('Disease', 'Parasite', 'Invasion', 
                      'Eutrophication', 'Hypoxia', 'Warming',
                      'Acidification', 'Sea_level_rise', 'Severe_weather_events', 
                      'Mercury', 'POPs', 'Antibiotic', 
                      'Pesticide', 'HAB', 'Bacteria', 
                      'MCQ', 'MAQ', 'MCS', 'MAS', 'Climatic', 'Nonclimatic',
                      'Biological', 'Chemical')

FW_SYSTEM <- read_excel('../OUTPUTS/01-FW-SYSTEM.xlsx')
MARINE_SYSTEM <- read_excel('../OUTPUTS/02-MARINE-SYSTEM.xlsx')

# Pre-process for both system
# FW-system
FW_SYSTEM_Clean <- FW_SYSTEM |> 
  mutate(HAB = NA) |> # Add a NA column of Fresh water HAB for the reuse purpose of elder scripts
  dplyr::select(all_of(SEQ_FW_TITLE))
MARINE_SYSTEM_CLean <- MARINE_SYSTEM |> 
  dplyr::select(-all_of(COUNTRY_INDEX)) |> # Remove index columns in raw outputs
  dplyr::select(all_of(SEQ_MARINE_TITLE))
```

### Load Social variables

```{r}
SOCIAL_SYSTEM <- read.csv('../ORGANIZED_DATA/17-Social-VARs.csv')

SOCIAL_SYSTEM_Clean <- SOCIAL_SYSTEM |> 
  dplyr::select(-all_of(COUNTRY_INDEX))
```

### Combine the final table for plotting in paper

```{r}
BLUE_FOOD_RISK <- bind_cols(FW_SYSTEM_Clean, MARINE_SYSTEM_CLean, SOCIAL_SYSTEM_Clean)
```

## Figure 1

*Figure 1. Top five countries with the highest exposure to anthropogenic stresses in terms of (a) production quantity and (b) food safety.*

### Aggregate Data

```{r}
FWQ_STRESSOR <- c('Disease', 'Parasite' , 'Invasion', 
         'Eutrophication', 'Precipitation', 
         'Warming', 'Severe_weather_events')
FWS_STRESSOR <- c('Mercury', 'POPs', 'Antibiotic', 'Pesticide', 'Bacteria')
FW_CLIM_STRESSOR <- c('Precipitation', 'Warming', 'Severe_weather_events')
FW_NCLIM_STRESSOR <- c('Eutrophication', 'Disease', 'Invasion', 'Parasite')
FW_CHEM_STRESSOR <- c('Mercury', 'POPs', 'Pesticide', 'Antibiotic')
FW_BIO_STRESSOR <- c('Bacteria')

FW_RANKING <- FW_SYSTEM |> 
  dplyr::select(ISO, FORMAL_EN, Disease, Parasite , Invasion , 
         Eutrophication, Precipitation, 
         Warming, Severe_weather_events, Mercury, 
         POPs, Antibiotic, Pesticide, Bacteria) |> 
  pivot_longer(-c(ISO, FORMAL_EN), 
               names_to = 'Stressors',
               values_to = 'value') |> 
  group_by(Stressors) |> 
  arrange(desc(value)) |> 
  mutate(rank = row_number()) |> 
  ungroup() |> 
  filter(rank <= 5) |> 
  dplyr::select(-rank) |> 
  mutate(System = case_when(Stressors %in% FWQ_STRESSOR ~ 'Quantity',
                            Stressors %in% FWS_STRESSOR ~ 'Safety'),
         Group = 'Freshwater',
         Type = case_when(Stressors %in% FW_CLIM_STRESSOR ~ 'Climatic',
                          Stressors %in% FW_NCLIM_STRESSOR ~ 'Non-climatic',
                          Stressors %in% FW_CHEM_STRESSOR ~ 'Chemical',
                          Stressors %in% FW_BIO_STRESSOR ~ 'Biological'),
         Stressors = paste(Stressors, Group, sep = ' '),
         Stressors = str_replace_all(Stressors, '_', ' ')) |> 
  rename(Full = FORMAL_EN,
         Country = ISO,
         Value = value)

```

```{r}
MQ_STRESSOR <- c('Disease', 'Parasite' , 'Invasion', 
         'Eutrophication', 'Hypoxia', 'Warming', 
         'Acidification', 'Sea_level_rise', 'Severe_weather_events')
MS_STRESSOR <- c('Mercury', 'POPs', 'Antibiotic', 'Pesticide', 'HAB',
                 'Bacteria')
M_CLIM_STRESSOR <- c('Warming', 'Acidification', 'Sea_level_rise', 
                     'Severe_weather_events')
M_NCLIM_STRESSOR <- c('Hypoxia', 'Eutrophication', 'Disease', 
                      'Invasion', 'Parasite')
M_CHEM_STRESSOR <- c('Mercury', 'POPs', 'Pesticide', 'Antibiotic')
M_BIO_STRESSOR <- c('HAB', 'Bacteria')


M_RANKING <- MARINE_SYSTEM |> 
  dplyr::select(ISO, FORMAL_EN, Disease, Parasite , Invasion , 
         Eutrophication, Hypoxia, Warming, 
         Acidification, Sea_level_rise, Severe_weather_events, 
         Mercury, POPs, Antibiotic, Pesticide, HAB, Bacteria) |> 
  pivot_longer(-c(ISO, FORMAL_EN), 
               names_to = 'Stressors',
               values_to = 'value') |> 
  group_by(Stressors) |> 
  arrange(desc(value)) |> 
  mutate(rank = row_number()) |> 
  ungroup() |> 
  filter(rank <= 5) |> 
  dplyr::select(-rank) |> 
  mutate(System = case_when(Stressors %in% MQ_STRESSOR ~ 'Quantity',
                            Stressors %in% MS_STRESSOR ~ 'Safety'),
         Group = 'Marine',
         Type = case_when(Stressors %in% M_CLIM_STRESSOR ~ 'Climatic',
                          Stressors %in% M_NCLIM_STRESSOR ~ 'Non-climatic',
                          Stressors %in% M_CHEM_STRESSOR ~ 'Chemical',
                          Stressors %in% M_BIO_STRESSOR ~ 'Biological'),
         Stressors = paste(Stressors, Group, sep = ' '),
         Stressors = str_replace_all(Stressors, '_', ' ')) |> 
  rename(Full = FORMAL_EN,
         Country = ISO,
         Value = value)
```

### Generate Plot

```{r}
data <- bind_rows(FW_RANKING, M_RANKING)
data <- data |> 
  filter(!Stressors %in% c("Disease Marine", "Invasion Marine")) |> 
  mutate(Stressors = if_else(Stressors == "Disease Freshwater", 
                             "Disease Both", Stressors),
         Stressors = if_else(Stressors == "Invasion Freshwater", 
                             "Invasion Both", Stressors),
         Stressors = str_replace(Stressors, "Severe weather events", 'S.weather'),
         Stressors = str_replace(Stressors, "Sea level rise", 'SLR')) |> 
  left_join(COUNTRY_ABB, by = c('Country' = 'ISO'))
```

```{r}
data1=subset(data,System=="Quantity")
data2=subset(data,System=="Safety")

Rank1 <- data1 %>% 
  mutate(Stressors = str_replace(Stressors, 'Eutrophication', 'Eutrophi.'),
         g_Country = reorder_within(Country_ABB, Value, Stressors),) %>% 
  ggplot(aes(x=g_Country, y=Value)) +
  geom_segment(aes(xend=g_Country, yend=0),color="grey") +
  geom_point(size=2, color="#FC5185") +
  coord_flip() +
  scale_x_reordered() +
  xlab("")+
  ylab("Standardized Exposure Scores")+
    facet_wrap(Stressors~., scales="free_y",ncol = 1,
               labeller = labeller(Stressors = label_wrap_gen(width = 12)), 
               strip.position = "right") +
    theme_bw() +
    theme(strip.text.y = element_text(size = 6),
          panel.grid = element_blank(),axis.line = element_blank(),
          panel.border = element_blank(), #strip.background.y = element_blank(),
          axis.title = element_blank(),legend.position='none',
          axis.text = element_text(size = 7, family = 'Arial', face = 'bold'),
          strip.background = element_rect(linetype = 'solid',
                                          size = .5, color = 'black'))

Rank2 <- data2 %>% 
  mutate(g_Country = reorder_within(Country_ABB, Value, Stressors)) %>% 
  ggplot(aes(x=g_Country, y=Value)) +
  geom_segment(aes(xend=g_Country, yend=0),color="grey") +
  geom_point(size=2, color="#FC5185") +
  coord_flip() +
  scale_x_reordered() +
    facet_wrap(Stressors~., scales="free_y",ncol = 1,
               labeller = labeller(Stressors = label_wrap_gen(width = 15)),
               strip.position = "right") +
  xlab("")+
  ylab("Standardized Exposure Scores")+
  theme_bw() + 
  theme(strip.text.y = element_text(size = 6),
        panel.grid = element_blank(),axis.line = element_blank(),
        panel.border = element_blank(),
        axis.title = element_blank(),legend.position='none',
        axis.text = element_text(size = 7, family = 'Arial', face = 'bold'),
        strip.background = element_rect(linetype = 'solid',
                                       size = .5, color = 'black'))
```

### Show Fig.1

```{r}
(Rank1 + Rank2) +plot_annotation(tag_levels = 'A') &
    theme(plot.tag = element_text(size = 7,
                                  family = 'Arial',
                                  face = 'bold'))
```
### Save Fig.1

```{r}
FIG_SAVE_PATH <- '../FIGURES/Test_Output_20221114_1//Fig 1.pdf'

cairo_pdf(FIG_SAVE_PATH, width = conv_unit(180, 'mm', 'inch'),
          height = conv_unit(210, 'mm', 'inch'))
(Rank1 + Rank2) +plot_annotation(tag_levels = 'a') &
    theme(plot.tag = element_text(size = 7,
                                  family = 'Arial',
                                  face = 'bold'))
dev.off()
```

## Figure 3

*Figure 3. Estimated impact of anthropogenic stresses on the global blue food production: (a) quantity; (b) safety.*

```{r}
world_map_path <- '../MAP_SET/country_modify/country.shp'
world_map <- read_sf(world_map_path)

fig3_data <- BLUE_FOOD_RISK %>% 
    dplyr::select(FORMAL_EN, ISO, CONTINENT,
           FCQ, FAQ, FCS, FAS,
           MCQ, MAQ, MCS, MAS) |> 
  mutate(FCQ = ifelse(FCQ == 0, NA, FCQ),
         FAQ = ifelse(FAQ == 0, NA, FAQ),
         FCS = ifelse(FCQ == 0, NA, FCS),
         FAS = ifelse(FAS == 0, NA, FAS),
         MCQ = ifelse(MCQ == 0, NA, MCQ),
         MAQ = ifelse(MAQ == 0, NA, MAQ),
         MCS = ifelse(MCQ == 0, NA, MCS),
         MAS = ifelse(MAS == 0, NA, MAS))

fig3_map_data <- world_map %>% 
    left_join(fig3_data,
              by = c('WB_A3' = 'ISO')) 

fig3_map_data <- world_map %>% 
    left_join(fig3_data,
              by = c('WB_A3' = 'ISO')) 

fig3_map_data_A <- fig3_map_data %>% 
    dplyr::select(-FCS, -FAS, -MCS, -MAS) %>% 
    pivot_longer(cols = c(FCQ, FAQ, MCQ, MAQ),
                 names_to = 'type',values_to = 'score') %>% 
    mutate(type = factor(type, levels = c('FCQ', 'FAQ', 'MCQ', 'MAQ')),
           label = case_when(type == 'FCQ' ~ 'FW capture',
                             type == 'FAQ' ~ 'FW culture',
                             type == 'MCQ' ~ 'Marine capture',
                             type == 'MAQ' ~ 'Mariculture'),
           score_bin =  cut_interval(score,length = .2))

score_labs <- c("0.0 ~ 0.2", "0.2 ~ 0.4", 
                "0.4 ~ 0.6", "0.6 ~ 0.8",
                "0.8 ~ 1.0", '')


fig3_A <- ggplot(fig3_map_data_A) +
    geom_sf(aes(fill = score_bin), size = .1) +
    facet_wrap(~type, 
               nrow = 2, strip.position = 'top') +
    geom_text(aes(x = 0, y = -50, label = label), 
              size = 7*.36, family = 'Arial') +
    ylab('(a) Impact on quantity') +
    scale_fill_brewer(palette = 'YlOrRd',
                      labels = score_labs, 
                      na.translate = F) +
    guides(fill = guide_legend(nrow = 1,
                               label.position = 'bottom', 
                               label.theme = element_text(family = 'Arial',
                                                          size = 5),
                               title = 'Standardized impact score',
                               title.position = 'top',
                               label.hjust = .5)) +
    theme_map(base_size = 7, base_family = 'Arial') +
    theme(panel.border = element_rect(size = .3, fill = NA),
          axis.title.y = element_text(size = 7, face = 'bold'),
          strip.background = element_blank(),
          strip.switch.pad.grid = unit(0, 'mm'),
          strip.text = element_blank(),
          legend.position = 'top',
          legend.direction = 'horizontal',
          legend.key.width = unit(5, 'mm'),
          legend.key.height = unit(2, 'mm'),
          legend.title = element_text(family = 'Arial', 
                                      face = 'bold',
                                      size = 7),
          legend.title.align = .5,
          legend.text = element_text(size = 5, 
                                     family = 'Arial'),
          legend.justification = 'center',
          legend.key = element_rect(color = 'black', size = unit(0.2, 'mm')))



fig3_map_data_B <- fig3_map_data %>% 
    dplyr::select(-FCQ, -FAQ, -MCQ, -MAQ) %>% 
    pivot_longer(cols = c(FCS, FAS, MCS, MAS),
                 names_to = 'type',values_to = 'score') %>% 
    mutate(type = factor(type, levels = c('FCS', 'FAS', 'MCS', 'MAS')),
           label = case_when(type == 'FCS' ~ 'FW capture',
                             type == 'FAS' ~ 'FW culture',
                             type == 'MCS' ~ 'Marine capture',
                             type == 'MAS' ~ 'Mariculture'),
           score_bin =  cut_interval(score,length = .2))


fig3_B <- ggplot(fig3_map_data_B) +
    geom_sf(aes(fill = score_bin), size = .1) +
    facet_wrap(~type, 
               nrow = 2, strip.position = 'top') +
    geom_text(aes(x = 0, y = -50, label = label), size = 7*.36,
              family = 'Arial') +
    ylab('(b) Impact on safety') +
    scale_fill_brewer(palette = 'YlOrRd',
                      labels = score_labs) + 
    theme_map(base_size = 7, base_family = 'Arial') +
    theme(panel.border = element_rect(size = .3, fill = NA),
          axis.title.y = element_text(size = 7, face = 'bold'),
          strip.background = element_blank(),
          strip.switch.pad.grid = unit(0, 'mm'),
          strip.text = element_blank(),
          legend.position = 'none')
```

### Show Fig.3

```{r}
fig3_A / fig3_B
```

### Save Fig.3

```{r}
FIG_SAVE_PATH <- '../FIGURES/Test_Output_20221114_1/Fig 3.pdf'
  
cairo_pdf(FIG_SAVE_PATH, 
          width = conv_unit(179, 'mm', 'inch'),
          height = conv_unit(150, 'mm', 'inch'),
          fallback_resolution = 72)
fig3_A / fig3_B
dev.off()
```

## Figure 4

*Figure 4. Cluster analysis based on the overall impact of all blue food systems for a total of 222 countries and territories: (a) heatmap and (b) radar plot of standardized impact scores of the four clusters obtained by k-means analysis.*

```{r}
##CLUSTER ANALYSIS & Heatmap
n=BLUE_FOOD_RISK[,c(1,20,21,22,23,43,44,45,46)]
n[is.na(n)] <- 0
colnames(n)=c("ISO", "FW capture quantity" , "FW culture quantity" , 
              "FW capture safety" , "FW culture safety" ,
              "Marine capture quantity", "Mariculture quantity" ,
              "Marine capture safety" , "Mariculture safety" )
n[is.na(n)] <- 0

# Min-Max normalization
normalize <- function(x) {return((x - min(x)) / (max(x) - min(x)))}
p <- as.data.frame(lapply(n[,-1], normalize))
rownames(p)=n$ISO
df <- scale(p)

## k-means plot
wss <- (nrow(df)-1)*sum(apply(df,2,var)) 
for (i in 2:15) wss[i] <- sum(kmeans(df, centers=i)$withinss) 
plot(1:15, wss, type="b", xlab="Number of Clusters",
     ylab="Within groups sum of squares") 
```

```{r}
FIG_SAVE_PATH <- '../FIGURES/Test_Output_20221114_1/Fig S11.pdf'
cairo_pdf(FIG_SAVE_PATH, width = conv_unit(150, 'mm', 'inch'),
          height = conv_unit(100, 'mm', 'inch'))
plot(1:15, wss, type="b", xlab="Number of Clusters",
     ylab="Within groups sum of squares") 
dev.off()
```



```{r}
## Heatmap analysis
set.seed(54321)
k=pheatmap(p, clustering_method = "ward.D2",kmeans_k = 4,
           cluster_cols  = FALSE, cellheight = 30,
           angle_col = 45, 
           color = colorRampPalette(c("#FEFFB3","#FFB24E", "#BD0026"))(60),
           show_rownames = F,
           fontsize = 5)
```

```{r}
cluster=k$kmeans$cluster
n1=cbind(BLUE_FOOD_RISK,cluster)
## Radar chart
n2=cbind(p,cluster)
n2[is.na(n2)]=0
datamean <- aggregate(n2[,c(1,2,3,4,5,6,7,8)],by=list(type=n2$cluster),mean)

datamean <- datamean %>% 
    mutate(type = as_factor(paste('Cluster', type)))

radar <- ggradar(datamean,values.radar=c("0","0.5","1.0"),
                 grid.max = 1.0,grid.min = 0, grid.mid = 0.5, 
                 group.colours = c("#FFD947","#FC5185", "#A9D158","#3FC1C9"), 
                 grid.label.size = 6*.35, group.point.size = 1,
                 background.circle.colour = "white", gridline.max.linetype = "solid",
                 gridline.label.offset = 0,  gridline.max.colour = "black", 
                 gridline.mid.colour = "grey", legend.position = "bottom",
                 axis.line.colour = "black",base.size = 7, font.radar = 'Arial',
                 axis.label.size = 7*.35, grid.line.width = .2,
                 group.line.width = .2) +
    theme(legend.text = element_text(size = 6, 
                                     family = 'Arial'),
          axis.text = element_text(size = 6, 
                                   family = 'Arial'),
          legend.key.width = unit(.5, 'cm'),
          plot.margin = unit(c(5, 5, 5, 5), 'mm'))

k_gg <- as.ggplot(k) +
    guides(fill = guide_colorbar()) +
    theme(legend.key.height = unit(2, 'cm'))
```

### Show Fig.4

```{r}
(k_gg / radar) + 
    plot_layout(heights = c(1, 1)) &
    plot_annotation(tag_levels = 'a', tag_prefix = '(', tag_suffix = ')') &
    theme(plot.tag = element_text(size = 7, 
                                    family = 'Arial'))
```
### Save Fig.4

```{r}
FIG_SAVE_PATH <- '../FIGURES/Test_Output_20221114_1/Fig 4.pdf'
cairo_pdf(FIG_SAVE_PATH, width = conv_unit(88, 'mm', 'inch'),
          height = conv_unit(150, 'mm', 'inch'))
(k_gg / radar) + 
    plot_layout(heights = c(1, 1)) &
    plot_annotation(tag_levels = 'a', tag_prefix = '(', tag_suffix = ')') &
    theme(plot.tag = element_text(size = 7, 
                                  family = 'Arial'))
dev.off()


 xlsx::write.xlsx(n2, '../OUTPUTS/03-RES-CLUSTER.xlsx')
```

## Figure 5

*Figure 5. Relationship between the estimated impact and national response capacity of each blue food nation. *

### Plottings

**The script is messed up for historical reasons, but works anyway**

```{r}
m=BLUE_FOOD_RISK

IC <- m[,c(1,20,22,54,55,6,4)] ## inland capture
IA <- m[,c(1,21,23,54,57,6,4)] ## inland aquac
MC <- m[,c(1,43,45,54,56,6,4)] ## marine capture
MA <- m[,c(1,44,46,54,58,6,4)] ## marine aqua

IC=na.omit(IC)
colnames(IC) <- c("ISO","QPI", "SPI", "Cap", "Pro", "Cont", "lev")

IA=na.omit(IA)
colnames(IA) <- c("ISO","QPI", "SPI", "Cap", "Pro", "Cont", "lev")
MC=na.omit(MC)
colnames(MC) <- c("ISO","QPI", "SPI", "Cap", "Pro", "Cont", "lev")
MA=na.omit(MA)
colnames(MA) <- c("ISO","QPI", "SPI", "Cap", "Pro", "Cont", "lev")

## Code for figure 5
## FIGURE5 Quantity FW CAPTURE
IC1=ggplot(IC, aes(y = QPI, x = Cap)) + 
  geom_point(aes(color = Cont, size = (Pro)^(1/3)), alpha = 0.5) +
  scale_x_continuous(limits = c(0, 1)) +  
  scale_color_manual(values = c("#FFD947","#FC5185", "#A9D158","#3FC1C9", "#B389ED")) +
  scale_size(range = c(0.1, 5))+ 
    geom_text(x = .1, y = .9, label = "FW capture", size = 7*.36) +
    geom_text_repel(data= subset(IC,QPI > max(IC$QPI)*2/3 | QPI < max(IC$QPI)/3 | Cap < max(IC$Cap)/3 | Cap > max(IC$Cap)*2/3),
                    aes(label=ISO), size= conv_unit(5, 'point', 'mm'),
                    family = 'Arial') + 
  geom_hline(yintercept = 0.333,lty="dashed")+
  geom_hline(yintercept = 0.666,lty="dashed")+
  geom_vline(xintercept = 0.333,lty="dashed")+
  geom_vline(xintercept = 0.666,lty="dashed")+
  theme_classic(base_family = 'Arial')+
  theme(axis.title = element_blank(),
        legend.position = "none", 
        axis.text = element_text(size = 7))

IC2<-ggplot(IC,aes(Cap))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
IC3<-ggplot(IC,aes(QPI))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())+
  coord_flip()
IC4=IC1%>%
  insert_top(IC2,height = 0.1)%>%
  insert_right(IC3,0.1)  
##outliers
IC.reg=lm(IC$QPI~IC$Cap)
outlierTest(IC.reg)

## FIGURE5 Quantity FW CULTURE
IA1=ggplot(IA, aes(y = QPI, x = Cap)) + 
  geom_point(aes(color = Cont, size = (Pro)^(1/3)), alpha = 0.5) + 
  scale_color_manual(values = c("#FFD947","#FC5185", "#A9D158","#3FC1C9", "#B389ED")) +
    scale_size(range = c(0.1, 5))+ 
    geom_text(x = .1, y = .9, label = "FW culture", size = 7*.36) +
    xlim(0, 1) +
  geom_text_repel(data= subset(IA,QPI > max(IA$QPI)*2/3 | QPI < max(IA$QPI)/3 | Cap < max(IA$Cap)/3 | Cap > max(IA$Cap)*2/3),
                  aes(label=ISO), size= conv_unit(5, 'point', 'mm'), 
                  family = 'Arial') + 
  geom_hline(yintercept = 0.333,lty="dashed")+
  geom_hline(yintercept = 0.666,lty="dashed")+
  geom_vline(xintercept = 0.333,lty="dashed")+
  geom_vline(xintercept = 0.666,lty="dashed")+
  theme_classic(base_size = 7, base_family = 'Arial')+
  theme(axis.title = element_blank(),
        legend.position = "none", 
        axis.text = element_text(size = 7,
                                 family = 'Arial'))

IA2<-ggplot(IA,aes(Cap))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
IA3<-ggplot(IA,aes(QPI))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())+
  coord_flip()
IA4=IA1%>%
  insert_top(IA2,height = 0.1)%>%
  insert_right(IA3,0.1)
##outliers
IA.reg=lm(IA$QPI~IA$Cap)
outlierTest(IA.reg)

## FIGURE5 Quantity MARINE CAPTURE
MC1=ggplot(MC, aes(y = QPI, x = Cap)) + 
  geom_point(aes(color = Cont, size = (Pro)^(1/3)), alpha = 0.5) + 
  scale_color_manual(values = c("#FFD947","#FC5185", "#A9D158","#3FC1C9", "#B389ED")) +
    scale_size(range = c(0.1, 5))+ 
    geom_text(x = .1, y = .9, label = "Marine capture", size = 7*.36) +
    xlim(0, 1) +
  geom_text_repel(data= subset(MC,QPI > max(MC$QPI)*2/3 | QPI < max(MC$QPI)/3 | Cap < max(MC$Cap)/3 | Cap > max(MC$Cap)*2/3),
                  aes(label=ISO), size= conv_unit(5, 'point', 'mm'),
                  family = 'Arial') + 
  geom_hline(yintercept = 0.333,lty="dashed")+
  geom_hline(yintercept = 0.666,lty="dashed")+
  geom_vline(xintercept = 0.333,lty="dashed")+
  geom_vline(xintercept = 0.666,lty="dashed")+
  theme_classic(base_size = 7, base_family = 'Arial')+
  theme(axis.title = element_blank(),
        legend.position = "none",
        axis.text = element_text(size = 7, 
                                 family = 'Arial'))

MC2<-ggplot(MC,aes(Cap))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
MC3<-ggplot(MC,aes(QPI))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())+
  coord_flip()
MC4=MC1%>%
  insert_top(MC2,height = 0.1)%>%
  insert_right(MC3,0.1) 
##outliers
MC.reg=lm(MC$QPI~MC$Cap)
outlierTest(MC.reg)

## FIGURE5 Quantity MARINE CULTURE
MA1=ggplot(MA, aes(y = QPI, x = Cap)) + 
  geom_point(aes(color = Cont, size = (Pro)^(1/3)), alpha = 0.5) + 
  scale_color_manual(values = c("#FFD947","#FC5185", "#A9D158","#3FC1C9", "#B389ED")) +
    scale_size(range = c(0.1, 5))+ 
    geom_text(x = .1, y = .9, label = "Mariculture", size = 7*.36) +
    xlim(0, 1) +
  geom_text_repel(data= subset(MA,QPI > max(MA$QPI)*2/3 | QPI < max(MA$QPI)/3 | Cap < max(MA$Cap)/3 | Cap > max(MA$Cap)*2/3),
                  aes(label=ISO),size= conv_unit(5, 'point', 'mm'),
                  family = 'Arial') + 
  geom_hline(yintercept = 0.333,lty="dashed")+
  geom_hline(yintercept = 0.666,lty="dashed")+
  geom_vline(xintercept = 0.333,lty="dashed")+
  geom_vline(xintercept = 0.666,lty="dashed")+
  theme_classic(base_size = 7, base_family = 'Arial')+
  theme(axis.title = element_blank(),legend.position = "none",
        axis.text = element_text(size = 7, family = 'Arial'))

MA2<-ggplot(MA,aes(Cap))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
MA3<-ggplot(MA,aes(QPI))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())+
  coord_flip()
MA4=MA1%>%
  insert_top(MA2,height = 0.1)%>%
  insert_right(MA3,0.1) 
##outliers
MA.reg=lm(MA$QPI~MA$Cap)
outlierTest(MA.reg)

## FIGURE5 SAFETY FW CAPTURE
SIC1 <- ggplot(IC, aes(y = SPI, x = Cap)) + 
  geom_point(aes(color = Cont, size = (Pro)^(1/3)), alpha = 0.5) + 
  scale_color_manual(values = c("#FFD947","#FC5185", "#A9D158","#3FC1C9", "#B389ED")) +
    scale_size(range = c(0.1, 5))+ 
    geom_text(x = .1, y = .9, label = "FW capture", size = 7*.36) +
    xlim(0, 1) +
  geom_text_repel(data= subset(IC,SPI > max(IC$SPI)*2/3 | SPI < max(IC$SPI)/3 | Cap < max(IC$Cap)/3 | Cap > max(IC$Cap)*2/3),
                  aes(label=ISO), size= conv_unit(5, 'point', 'mm'),
                  family = 'Arial') + 
  geom_hline(yintercept = 0.333,lty="dashed")+
  geom_hline(yintercept = 0.666,lty="dashed")+
  geom_vline(xintercept = 0.333,lty="dashed")+
  geom_vline(xintercept = 0.666,lty="dashed")+
  theme_classic(base_size = 7, base_family = 'Arial')+
  theme(axis.title = element_blank(),
        legend.position = "none",
        axis.text = element_text(size = 7,
                                 family = 'Arial'))

SIC2<-ggplot(IC,aes(Cap))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
SIC3<-ggplot(IC,aes(SPI))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())+
  coord_flip()
SIC4=SIC1%>%
  insert_top(SIC2,height = 0.1)%>%
  insert_right(SIC3,0.1)  
##outliers
SIC.reg=lm(IC$SPI~IC$Cap)
outlierTest(IC.reg)

## FIGURE5 SAFETY FW CULTURE
SIA1=ggplot(IA, aes(y = SPI, x = Cap)) + 
  geom_point(aes(color = Cont, size = (Pro)^(1/3)), alpha = 0.5) + 
  scale_color_manual(values = c("#FFD947","#FC5185", "#A9D158","#3FC1C9", "#B389ED")) +
    scale_size(range = c(0.1, 5))+ 
    geom_text(x = .1, y = .9, label = "FW culture", size = 7*.36) +
    xlim(0, 1) +
  geom_text_repel(data= subset(IA,SPI > max(IA$SPI)*2/3 | SPI < max(IA$SPI)/3 | Cap < max(IA$Cap)/3 | Cap > max(IA$Cap)*2/3),
                  aes(label=ISO), size= conv_unit(5, 'point', 'mm'),
                  family = 'Arial') + 
  geom_hline(yintercept = 0.333,lty="dashed")+
  geom_hline(yintercept = 0.666,lty="dashed")+
  geom_vline(xintercept = 0.333,lty="dashed")+
  geom_vline(xintercept = 0.666,lty="dashed")+
  theme_classic(base_size = 7,
                base_family = 'Arial')+
  theme(axis.title = element_blank(),
        legend.position = "none",
        axis.text = element_text(size = 7,
                                 family = 'Arial'))

SIA2<-ggplot(IA,aes(Cap))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
SIA3<-ggplot(IA,aes(SPI))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())+
  coord_flip()
SIA4=SIA1%>%
  insert_top(SIA2,height = 0.1)%>%
  insert_right(SIA3,0.1) 
##outliers
SIA.wreg=lm(IA$SPI~IA$Cap)
outlierTest(IA.reg)

## FIGURE5 SAFETY MARINE CAPTURE
SMC1=ggplot(MC, aes(y = SPI, x = Cap)) + 
  geom_point(aes(color = Cont, size = (Pro)^(1/3)), alpha = 0.5) + 
  scale_color_manual(values = c("#FFD947","#FC5185", "#A9D158","#3FC1C9", "#B389ED")) +
    scale_size(range = c(0.1, 5))+ 
    geom_text(x = .1, y = .9, 
              label = "Marine capture", size = 7*.35,
              family = 'Arial') +
    xlim(0, 1) +
  geom_text_repel(data= subset(MC,SPI > max(MC$SPI)*2/3 | SPI < max(MC$SPI)/3 | Cap < max(MC$Cap)/3 | Cap > max(MC$Cap)*2/3),
                  aes(label=ISO), size= conv_unit(5, 'point', 'mm'),
                  family = 'Arial') + 
  geom_hline(yintercept = 0.333,lty="dashed")+
  geom_hline(yintercept = 0.666,lty="dashed")+
  geom_vline(xintercept = 0.333,lty="dashed")+
  geom_vline(xintercept = 0.666,lty="dashed")+
  theme_classic(base_size = 7, base_family = 'Arial')+
  theme(axis.title = element_blank(),legend.position = "none",
        axis.text = element_text(size = 7, family = 'Arial'))

SMC2<-ggplot(MC,aes(Cap))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
SMC3<-ggplot(MC,aes(SPI))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())+
  coord_flip()
SMC4=SMC1%>%
  insert_top(SMC2,height = 0.1)%>%
  insert_right(SMC3,0.1) 
##outliers
SMC.reg=lm(MC$SPI~MC$Cap)
outlierTest(MC.reg)

## FIGURE5 SAFETY MARINE CULTURE
SMA1=ggplot(MA, aes(y = SPI, x = Cap)) + 
  geom_point(aes(color = Cont, size = (Pro)^(1/3)), alpha = 0.5) + 
  scale_color_manual(values = c("#FFD947","#FC5185", "#A9D158","#3FC1C9", "#B389ED")) +
    scale_size(range = c(0.1, 5),
               labels = c(expression(''~10^4~''),
                          expression(''~10^6~''),
                          expression(''~10^8~'')),
               breaks = c(100, 200, 300))+ 
    geom_text(x = .1, y = .9, label = "Mariculture", size = 7*.36) +
    geom_text_repel(data= subset(MA,SPI > max(MA$SPI)*2/3 | SPI < max(MA$SPI)/3 | Cap < max(MA$Cap)/3 | Cap > max(MA$Cap)*2/3),
                    aes(label=ISO),size= conv_unit(5, 'point', 'mm'),
                    family = 'Arial',) +
    xlim(0, 1) +
  guides(size = guide_legend(title = 'Production',
                             title.theme = element_text(size = 7,
                                                        family = 'Arial',
                                                        face = 'bold'),
                             label.theme = element_text(size = 5,
                                                        family = 'Arial',
                                                        face = 'bold')),
         color = guide_legend(title = 'Continent',
                              title.theme = element_text(size = 7,
                                                         family = 'Arial',
                                                         face = 'bold'),
                              label.theme = element_text(size = 5,
                                                         family = 'Arial',
                                                         face = 'bold'))) +
  geom_hline(yintercept = 0.333,lty="dashed")+
  geom_hline(yintercept = 0.666,lty="dashed")+
  geom_vline(xintercept = 0.333,lty="dashed")+
  geom_vline(xintercept = 0.666,lty="dashed")+
  theme_classic(base_size = 7)+
  theme(axis.title = element_blank(),
        axis.text = element_text(size = 7, family = 'Arial'),
        legend.position = 'bottom', 
        legend.direction = 'horizontal')
legnd <- ggpubr::get_legend(SMA1)

SMA2<-ggplot(MA,aes(Cap))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
SMA3<-ggplot(MA,aes(SPI))+
  geom_density(fill="grey",alpha=0.5)+
  scale_y_continuous(expand = c(0,0))+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())+
  coord_flip()
SMA4=(SMA1 + theme(legend.position = 'none'))%>%
  insert_top(SMA2,height = 0.1)%>%
  insert_right(SMA3,0.1) 
##outliers
SMA.reg=lm(MA$SPI~MA$Cap)
outlierTest(MA.reg)
```

### Aggregate and output

**!!DO NOT CHANGE THE VARIABLE NAMES HERE, ABOVE SCRIPT IS MESSED UP**

```{r}

grid_a <- plot_list(IC4, IA4, MC4, MA4,
          ncol = 2)

grid_a_title <- ggplot(data.frame(l = '(a) Predicted impact on quantity', 
                                 x = 1, y = 1)) +
    geom_text(aes(x, y, label = l), angle = 90, 
              size = 7*.35, family = 'Arial') + 
    theme_void() +
    coord_cartesian(clip = "off")
grid_a_final <- grid_a_title + grid_a +
    plot_layout(widths = c(1, 25))


legnd <- ggpubr::get_legend(SMA1)
grid_b <- plot_list(SIC4, SIA4, SMC4, SMA4,
                    ncol = 2)
    
grid_b_title <- ggplot(data.frame(l = '(b) Predicted impact on safety', 
                                  x = 1, y = 1)) +
    geom_text(aes(x, y, label = l), angle = 90, size = 7*.35) + 
    theme_void() +
    coord_cartesian(clip = "off")
grid_b_no_legnd <- (grid_b_title + grid_b) +
    plot_layout(widths = c(1, 25))

grid_b_x_xis <- ggplot(data.frame(l = 'National response capacity', 
                                  x = 1, y = 1)) +
    geom_text(aes(x, y, label = l), size = .35*7, family = 'Arial') + 
    theme_void() +
    coord_cartesian(clip = "off")

grid_b_final<- (grid_b_no_legnd/grid_b_x_xis/legnd) +
    plot_layout(heights = c(25, 1, 1))
```

### Show Fig.5

```{r}
grid_a_final / grid_b_final
```

### Save Fig.5

```{r}
FIG_SAVE_PATH <- '../FIGURES/Test_Output_20221114_1/Fig 5.pdf'
cairo_pdf(FIG_SAVE_PATH, 
          width = conv_unit(164, 'mm', 'inch'),
          height = conv_unit(225, 'mm', 'inch'))
grid_a_final / grid_b_final
dev.off()
```

## Fig S2-S3

**Figure S2. Standardized intensity scores of climatic (A,C) and non-climatic (B, D) stressors affecting blue food production quantity in inland (A, B) and marine (C, D) areas.**

**Figure S3. Standardized intensity scores of biological (A, C) and chemical (B, D) stressors affecting blue food safety in inland (A, B) and marine (C, D) areas. Results were standardized and presented at the national level. **

***NOTE: Figure S2 && S3 are mbined here for output! A-D belong to Figure S2, E-H belong to S3; And are manually splited in Adobe Illustrator wit no data and style modification***

### Gather the data

**Mainly for reuse elder codes**
```{r}
stat_data <- bind_cols(FW_SYSTEM_Clean |> 
            rename(`FW Cli` = Climatic,
                   `FW Noncli` = Nonclimatic,
                   `FW Bio` = Biological,
                   `Fw Chem` = Chemical), 
          MARINE_SYSTEM_CLean |> 
            rename(`M Cli` = Climatic,
                   `M Noncli` = Nonclimatic,
                   `M Bio` = Biological,
                   `M Chem` = Chemical), 
          SOCIAL_SYSTEM_Clean)
```

```{r}
figS2_data <- stat_data %>% 
    dplyr::select(ISO,
           `FW Cli`, `FW Noncli`, `M Cli`, `M Noncli`,
           `FW Bio`, `Fw Chem`, `M Bio`, `M Chem`) %>% 
    mutate(`FW Cli` = if_else(`FW Cli` == 0, NaN, `FW Cli`),
           `FW Noncli` = if_else(`FW Noncli` == 0, NaN, `FW Noncli`),
           `M Cli` = if_else( `M Cli` == 0, NaN,  `M Cli`),
           `M Noncli` = if_else(`M Noncli` == 0, NaN, `M Noncli`),
           `FW Bio` = if_else(`FW Bio` == 0, NaN, `FW Bio`),
           `Fw Chem` = if_else(`Fw Chem` == 0, NaN, `Fw Chem`),
           `M Bio` = if_else(`M Bio` == 0, NaN, `M Bio`),
           `M Chem` = if_else(`M Chem` ==0, NaN, `M Chem`))

figS2_map_data <- world_map %>% 
    left_join(figS2_data,
              by = c('WB_A3' = 'ISO')) 

figS2_map_data <- figS2_map_data %>% 
    rename(A = `FW Cli`, B = `FW Noncli`, C = `M Cli`, D = `M Noncli`,
           E = `FW Bio`, F = `Fw Chem`, G = `M Bio`, H = `M Chem`) %>% 
    pivot_longer(cols = c(A, B, C, D, E, F, G, H),
                 names_to = 'type',values_to = 'score') %>% 
    mutate(type = factor(type, levels = c('A', 'B', 'C', 'D','E', 'F', 'G', 'H')),
           label = case_when(type == 'A' ~ 'A',
                             type == 'B' ~ 'B',
                             type == 'C' ~ 'C',
                             type == 'D' ~ 'D',
                             type == 'E' ~ 'E',
                             type == 'F' ~ 'F',
                             type == 'G' ~ 'G',
                             type == 'H' ~ 'H',),
           score_bin =  cut_interval(score,length = .2))

score_labs <- c("0.0 ~ 0.2", "0.2 ~ 0.4", 
                "0.4 ~ 0.6", "0.6 ~ 0.8",
                "0.8 ~ 1.0", '')

figS2 <- ggplot(figS2_map_data) +
    geom_sf(aes(fill = score_bin), size = .1) +
    facet_wrap(~type, 
               ncol = 2, strip.position = 'top') +
    geom_text(aes(x = 0, y = -50, label = label), 
              size = 7*.36, family = 'Arial') +
    scale_fill_brewer(palette = 'YlOrRd',
                      labels = score_labs, 
                      na.translate = F) +
    guides(fill = guide_legend(nrow = 1,
                               label.position = 'bottom', 
                               label.theme = element_text(family = 'Arial',
                                                          size = 5),
                               title = 'Standardized intensity score',
                               title.position = 'top',
                               label.hjust = .5)) +
    theme_map(base_size = 7, base_family = 'Arial') +
    theme(panel.border = element_rect(size = .3, fill = NA),
          strip.background = element_blank(),
          strip.switch.pad.grid = unit(0, 'mm'),
          strip.text = element_blank(),
          legend.position = 'top',
          legend.direction = 'horizontal',
          legend.key.width = unit(5, 'mm'),
          legend.key.height = unit(2, 'mm'),
          legend.title = element_text(family = 'Arial', 
                                      face = 'bold',
                                      size = 7),
          legend.title.align = .5,
          legend.text = element_text(size = 5, 
                                     family = 'Arial'),
          legend.justification = 'center',
          legend.key = element_rect(color = 'black', size = unit(0.2, 'mm')))
```

### Show Fig.S2-S3

```{r}
figS2
```

```{r}
FIG_SAVE_PATH <- '../FIGURES/Test_Output_20221114_1/Fig S2-3.pdf'
cairo_pdf(FIG_SAVE_PATH, 
          width = conv_unit(179, 'mm', 'inch'),
          height = conv_unit(210, 'mm', 'inch'),
          fallback_resolution = 72)
figS2
dev.off()
```

## Fig S4

**Figure S4. Standardized predicted impact on blue food production by continent: (a) production quantity; (b) food safety. **

```{r}
m <- BLUE_FOOD_RISK
IC <- m[,c(1,20,22,54,55,6,4)]
IA <- m[,c(1,21,23,54,57,6,4)]
MC <- m[,c(1,43,45,54,56,6,4)]
MA <- m[,c(1,44,46,54,58,6,4)]

IC=na.omit(IC)
colnames(IC) <- c("ISO","QPI", "SPI", "Cap", "Pro", "Cont", "lev")
IA=na.omit(IA)
colnames(IA) <- c("ISO","QPI", "SPI", "Cap", "Pro", "Cont", "lev")
MC=na.omit(MC)
colnames(MC) <- c("ISO","QPI", "SPI", "Cap", "Pro", "Cont", "lev")
MA=na.omit(MA)
colnames(MA) <- c("ISO","QPI", "SPI", "Cap", "Pro", "Cont", "lev")

IC$System="FW capture"
IA$System="FW culture"
MC$System="Marine capture"
MA$System="Mariculture"
m2=rbind(IC,IA,MC,MA)
m2=na.omit(m2)

m2 <- m2 %>% 
    mutate(System = factor(System, 
                           levels = c("FW capture",
                                      "FW culture",
                                      "Marine capture",
                                      "Mariculture")))


## Figure S4
p1<- ggplot(data=m2)+ 
  geom_boxplot(mapping=aes(x=Cont,y=QPI,colour = Cont), 
               alpha = 0.5,
               size=.5,
               width = 0.6)+ 
  geom_jitter(mapping=aes(x=Cont,y=QPI,colour = Cont), 
              alpha = 0.3,size=3)+
    facet_wrap(~System) +
  theme(strip.text.x = element_text(size = 7, family = 'Arial'), 
        axis.text = element_text(size=6, family = 'Arial'),
        axis.title = element_text(size=7, 
                                  family = 'Arial', face = 'bold'),
        legend.position="none")+
  labs(y = "(a) Quantity", x = "")+
  scale_color_manual(values=c("#FFA647", "#FFD947",
                              "#3FC1C9","#FC5185","#B389ED")) 

p2<- ggplot(data=m2)+ 
  geom_boxplot(mapping=aes(x=Cont,y=SPI,colour = Cont), 
               alpha = 0.5,
               size=.5,
               width = 0.6)+ 
  geom_jitter(mapping=aes(x=Cont,y=SPI,colour = Cont), #ɢ??
              alpha = 0.3,size=3)+
    facet_wrap(~System) +
  theme(strip.text.x = element_text(size = 7, family = 'Arial'),
        axis.text = element_text(size=6 ,family = 'Arial'),
        axis.title = element_text(size=7, family = 'Arial',
                                  face = 'bold'),
        legend.position="none")+
  labs(y = "(b) Safety", x = "Continent")+
  scale_color_manual(values=c("#FFA647", "#FFD947",
                              "#3FC1C9","#FC5185","#B389ED"))
```

### Show Fig S4

```{r}
p1 / p2
```
### Save Fig S4

```{r}
FIG_SAVE_PATH <- '../FIGURES/Test_Output_20221114_1/Fig S4.pdf'
cairo_pdf(FIG_SAVE_PATH, 
          width = conv_unit(179, 'mm', 'inch'),
          height = conv_unit(210, 'mm', 'inch'),
          fallback_resolution = 72)
p1 / p2
dev.off()
```

## Fig S5

```{r}
clean_uncertainty <- function(x){
  CLEARED_UNCERTAINTY <- x |> 
    mutate(LOWER = Avg - SD,
           UPPER = Avg + SD,
           LOWER = if_else(LOWER < 0, 0, LOWER)) |> 
    group_by(CONTINENT, System) |> 
    mutate(ID = row_number()) |> 
    ungroup()
}

UNCERTAINTIES_ <- list.files('../OUTPUTS/', 
                             pattern = 'UNCERTAINTY.xlsx',
                             full.names = T)
UNCERTAINTIES <- purrr::map(UNCERTAINTIES_, read_excel)

UNCERTAINTIES <- purrr::map(UNCERTAINTIES, clean_uncertainty)

UNCERTAINTY_TB <- bind_rows(UNCERTAINTIES) |> 
  mutate(SYSTEM = case_when(str_detect(System, 'Q')~'Quantity',
                            str_detect(System, 'S')~'Safety'),
         System_name = case_when(str_detect(System, 'FC') ~ 'FW capture',
                                 str_detect(System, 'FA') ~ 'FW aquaculture',
                                 str_detect(System, 'MC') ~ 'Marine capture',
                                 str_detect(System, 'MA') ~ 'Mariculture'))
```

```{r}
df_figs5_a <- UNCERTAINTY_TB |> 
  filter(SYSTEM == 'Quantity')
df_figs5_b <- UNCERTAINTY_TB |> 
  filter(SYSTEM == 'Safety')

figS5a <- ggplot(df_figs5_a, aes(x = ID, y = Avg)) +
    geom_point(size =.6) +
    geom_errorbar(aes(ymin = LOWER, 
                      ymax = UPPER)) +
    scale_x_continuous(labels = NULL, name = NULL)+
    theme_bw(base_size = 7, base_family = 'Arial') +
    facet_grid(CONTINENT ~ System_name) +
    scale_y_continuous(limits = c(0, 1)) +
    ylab('(a) Quantity') +
    theme(axis.title.y = element_text(size = 7, family = 'Arial',
                                      face = 'bold'))

figS5b <- ggplot(df_figs5_b, aes(x = ID, y = Avg)) +
    geom_point(size =.6) +
    geom_errorbar(aes(ymin = LOWER, 
                      ymax = UPPER)) +
    scale_x_continuous(labels = NULL, name = NULL)+
    theme_bw(base_size = 7, base_family = 'Arial') +
    facet_grid(CONTINENT ~ System_name) +
    scale_y_continuous(limits = c(0, 1)) +
    ylab('(b) Safety') +
    theme(axis.title.y = element_text(size = 7, family = 'Arial',
                                      face = 'bold'))
```

### Show Fig S5

```{r}
figS5a/figS5b
```

### Save Fig S5

```{r}
FIG_SAVE_PATH <- '../FIGURES/Test_Output_20221114_1/Fig S5.pdf'
cairo_pdf(FIG_SAVE_PATH, 
          width = conv_unit(179, 'mm', 'inch'),
          height = conv_unit(210, 'mm', 'inch'),
          fallback_resolution = 72)
figS5a / figS5b
dev.off()
```

## Fig S6

```{r}
m <- BLUE_FOOD_RISK

IC <- m[,c(1,20,22,54,55,6,4)]
IA <- m[,c(1,21,23,54,57,6,4)]
MC <- m[,c(1,43,45,54,56,6,4)]
MA <- m[,c(1,44,46,54,58,6,4)]

IC=na.omit(IC)
colnames(IC) <- c("ISO","QPI", "SPI", "Cap", "Pro", "Cont", "lev")
IA=na.omit(IA)
colnames(IA) <- c("ISO","QPI", "SPI", "Cap", "Pro", "Cont", "lev")
MC=na.omit(MC)
colnames(MC) <- c("ISO","QPI", "SPI", "Cap", "Pro", "Cont", "lev")
MA=na.omit(MA)
colnames(MA) <- c("ISO","QPI", "SPI", "Cap", "Pro", "Cont", "lev")

IC$System="FW capture"
IA$System="FW culture"
MC$System="Marine capture"
MA$System="Mariculture"
m2=rbind(IC,IA,MC,MA)
m2=na.omit(m2)

m2 <- m2 %>% 
    mutate(level = cut_interval(Cap, length = 1/3),
           level_tag = case_when(level == '[0,0.333]' ~ 'Low',
                                 level == '(0.333,0.667]' ~ 'Middle',
                                 level == '(0.667,1]' ~ 'High'),
           level_tag = factor(level_tag, 
                              levels = c('Low', 'Middle', 'High')),
           System = factor(System, 
                           levels = c("FW capture",
                                      "FW culture",
                                      "Marine capture",
                                      "Mariculture")))

##figure S5
figS6 <- ggplot(m2, aes(x = QPI, y = SPI, shape=level_tag)) + 
    geom_point(aes(color = Cont),size=3, alpha = 0.7) + 
    scale_color_manual(values = c("#FFD947","#FC5185", "#A9D158","#3FC1C9", "#B389ED")) +
    scale_size(range = c(0.5, 12))+ 
    geom_text_repel(label=m2$ISO, 
                    size = conv_unit(5, 'point', 'mm')) + 
    geom_hline(yintercept = max(m2$QPI)/3,lty="dashed")+
    geom_hline(yintercept = max(m2$QPI)*2/3,lty="dashed")+
    geom_vline(xintercept = max(m2$SPI)/3,lty="dashed")+
    geom_vline(xintercept = max(m2$SPI)*2/3,lty="dashed")+
    xlab("Quantity")+
    ylab("Safety")+
    facet_wrap(~System)+
    guides(shape = guide_legend(title = 'National response capacity',
                               label.theme = element_text(size = 6, 
                                                          family = 'Arial')),
           color = guide_legend(title = 'Continent', 
                                label.theme = element_text(size = 6,
                                                           family = 'Arial'))) +
    theme_bw(base_family = 'Arial')+
    theme(panel.grid = element_blank(),
          legend.position = "bottom",
          legend.direction = 'horizontal',
          legend.title = element_text(size = 6,
                                      family = 'Arial',
                                      face = 'bold'),
          legend.text = element_text(size = 5, family = 'Arial'),
          strip.text.x = element_text(size = 7, family = 'Arial'),
          axis.title = element_text(size = 7, family = 'Arial',
                                    face = 'bold'),
          axis.text = element_text(size = 6, 
                                   family = 'Arial'))
```

### Show Fig S6

```{r}
figS6
```

### Save Fig S6

```{r}
FIG_SAVE_PATH <- '../FIGURES/Test_Output_20221114_1/Fig S6.pdf'
cairo_pdf(FIG_SAVE_PATH, 
          width = conv_unit(179, 'mm', 'inch'),
          height = conv_unit(185, 'mm', 'inch'),
          fallback_resolution = 72)
figS6
dev.off()
```

## Fig S7

```{r}
figS7_data <- stat_data %>% 
    dplyr::select(ISO,
           capacity) %>% 
    mutate(capacity = if_else(capacity ==0, NaN, capacity))

figS7_map_data <- world_map %>% 
    left_join(figS7_data,
              by = c('WB_A3' = 'ISO')) %>% 
    mutate(score_bin = cut_interval(capacity,length = 1/3))

score_labs <- c("0.00 ~ 0.33", "0.34 ~ 0.67", 
                "0.68 ~ 1.00")

figS7 <- ggplot(figS7_map_data) +
    geom_sf(aes(fill = score_bin), size = .1) +
    scale_fill_brewer(palette = 'YlGn',
                      labels = score_labs, 
                      na.translate = F) +
    guides(fill = guide_legend(nrow = 1,
                               label.position = 'bottom', 
                               label.theme = element_text(family = 'Arial',
                                                          size = 5),
                               title = 'Standardized score',
                               title.position = 'bottom',
                               label.hjust = .5)) +
    theme_map(base_size = 7, base_family = 'Arial') +
    theme(panel.border = element_rect(size = .3, fill = NA),
          strip.background = element_blank(),
          strip.switch.pad.grid = unit(0, 'mm'),
          strip.text = element_blank(),
          legend.position = c(0.03, 0.05),
          legend.direction = 'horizontal',
          legend.key.width = unit(5, 'mm'),
          legend.key.height = unit(2, 'mm'),
          legend.title = element_text(family = 'Arial', 
                                      face = 'bold',
                                      size = 7),
          legend.title.align = .5,
          legend.text = element_text(size = 5, 
                                     family = 'Arial'),
          legend.key = element_rect(color = 'black', size = unit(0.2, 'mm')))
```

### Show Fig S7

```{r}
figS7
```

### Save Fig S7

```{r}
FIG_SAVE_PATH <- '../FIGURES/Test_Output_20221114_1/Fig S7.pdf'
cairo_pdf(FIG_SAVE_PATH, 
          width = conv_unit(179, 'mm', 'inch'),
          height = conv_unit(185, 'mm', 'inch'),
          fallback_resolution = 72)
figS7
dev.off()
```

## Fig S8

**Produced by ARCGIS**
```{r}
benthic_dir <- '../ORGANIZED_DATA/18-BENTHICS/'

d1 <- raster::raster(paste0(benthic_dir, 'benthic_sst.tif')) 
d2 <- raster::raster(paste0(benthic_dir, 'benthic_oa.tif')) 
d3 <- raster::raster(paste0(benthic_dir, 'benthic_eutro.tif')) 

plot(d1)
```

```{r}
p1/p2/p3
```

## Fig S9

```{r}
FigS9_A <- BLUE_FOOD_RISK[,c(6:17, 19, 41)] |> 
  pivot_longer(-CONTINENT, names_to = 'Var', values_to = 'Value') |> 
  mutate(Var = str_remove(Var, pattern = '\\.\\.\\.[0-9]*')) |> 
  ggplot(aes(x = Value)) +
  geom_histogram() +
  facet_wrap(~Var) +
  xlab('Standardized Score') +
  ylab('Frequency')

FigS9_B <- bind_cols(BLUE_FOOD_RISK[, 6], MARINE_SYSTEM_CLean[,1:15]) |> 
  pivot_longer(-CONTINENT, names_to = 'Var', values_to = 'Value') |> 
  mutate(Var = str_remove(Var, pattern = '\\.\\.\\.[0-9]*')) |> 
  ggplot(aes(x = Value)) +
  geom_histogram() +
  facet_wrap(~Var) +
  xlab('Standardized Score') +
  ylab('Frequency')
```

### Show Fig S9

```{r}
FigS9_A | FigS9_B
```

### Save Fig S9
```{r}
FIG_SAVE_PATH <- '../FIGURES/Test_Output_20221114_1/Fig S9.pdf'
cairo_pdf(FIG_SAVE_PATH, 
          width = conv_unit(179, 'mm', 'inch'),
          height = conv_unit(80, 'mm', 'inch'),
          fallback_resolution = 72)
((FigS9_A + theme(text = element_text(size = 5, family = 'Arial')))| 
    (FigS9_B  + theme(text = element_text(size = 5, family = 'Arial')))) +
  plot_layout(widths = c(1, 1)) &
    plot_annotation(tag_levels = 'a', tag_prefix = '(', tag_suffix = ')') &
    theme(plot.tag = element_text(size = 7, 
                                  family = 'Arial'))
dev.off()
```

### Summary Table

```{r}
cluster_summary <- n2 |> 
  as_tibble() |> 
  pivot_longer(-cluster) |> 
  group_by(cluster, name) |> 
  summarise(Avg = mean(value),
            SD = sd(value)) |> 
  ungroup() |> 
  mutate(Avg = round(Avg, 2),
         SD = round(SD, 2),
         Value = paste0(Avg,'(', SD, ')')) |> 
  dplyr::select(-Avg, -SD) |> 
  pivot_wider(names_from = cluster, values_from = Value) |> 
  mutate(name = str_replace_all(name, '\\.', ' ')) |> 
  rename(`System-catogary`=name)

xlsx::write.xlsx(cluster_summary, '../OUTPUTS/Cluster_summary.xlsx')
```

## Qipaotu

```{r}
write_csv(BLUE_FOOD_RISK, '../OUTPUTS/qipaotu.csv')
```
